name: Publish Alpha

on:
  push:
    branches-ignore:
      # Auto-deploy alphas only from NON long-lived branches.
      # (Long-lived branches like main/release/hotfix should not mint alpha tags.)
      - main
      - develop
      - release/**
      - hotfix/**
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to deploy alpha from (e.g. main, feature/foo)"
        required: false
        default: ""

concurrency:
  group: deploy-alpha-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  deploy-alpha:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.target_branch || github.ref_name }}

      - name: Get current version
        id: version
        run: |
          # Extract version from .toc file
          CURRENT_VERSION=$(grep "^## Version:" LariasWeeklyChecklist_Localization.toc | sed 's/## Version: //')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Get branch name
          BRANCH_NAME="${{ inputs.target_branch || github.ref_name }}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: newversion
        env:
          CURRENT: ${{ steps.version.outputs.current }}
        run: |
          set -euo pipefail

          # Ensure tags are available for version calculation.
          git fetch --tags --force

          # Versioning rules for alpha:
          # - If the repo already has alpha tags, bump the latest alpha tag's 4th component (build).
          # - Otherwise, bump the current stable PATCH once and start build at 1.
          # Examples:
          #   1.0.16          -> 1.0.17.1-alpha
          #   1.0.16.3-alpha  -> 1.0.16.4-alpha

          LATEST_ALPHA_TAG=$(git tag --list 'v*-alpha' --sort=-v:refname | head -n 1 || true)
          if [ -n "${LATEST_ALPHA_TAG:-}" ]; then
            BASE_VERSION="${LATEST_ALPHA_TAG#v}"
            BASE_VERSION="${BASE_VERSION%-alpha}"
            IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$BASE_VERSION"
            if [ -z "${BUILD:-}" ]; then BUILD=0; fi
            BUILD=$((BUILD + 1))
          else
            # Parse only MAJOR.MINOR.PATCH from CURRENT; ignore any 4th component.
            if [[ "${CURRENT:-}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              PATCH="${BASH_REMATCH[3]}"
            else
              MAJOR=0
              MINOR=0
              PATCH=0
            fi
            PATCH=$((PATCH + 1))
            BUILD=1
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH.$BUILD"
          ALPHA_VERSION="$NEW_VERSION-alpha"
          
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "alpha=$ALPHA_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in .toc file
        env:
          ALPHA_VERSION: ${{ steps.newversion.outputs.alpha }}
        run: |
          sed -i "s/^## Version:.*/## Version: $ALPHA_VERSION/" LariasWeeklyChecklist_Localization.toc
          sed -i "s/^## Title:.*/## Title: Larias's Weekly Checklist Localization (ALPHA)/" LariasWeeklyChecklist_Localization.toc

      - name: Commit and tag
        id: tagstep
        env:
          ALPHA_VERSION: ${{ steps.newversion.outputs.alpha }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add LariasWeeklyChecklist_Localization.toc
          git commit -m "Alpha release: $ALPHA_VERSION from ${{ steps.version.outputs.branch }}"
          
          TAG="v$ALPHA_VERSION"
          git tag -a "$TAG" -m "Alpha Release $ALPHA_VERSION"
          git push origin "$TAG"
          
          echo "tag=$TAG" >> $GITHUB_ENV
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release (prerelease)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagstep.outputs.tag }}
          name: ${{ steps.tagstep.outputs.tag }}
          prerelease: true
          generate_release_notes: true

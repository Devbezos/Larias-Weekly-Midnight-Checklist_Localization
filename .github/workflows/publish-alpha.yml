name: Deploy Alpha (Locales)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to deploy alpha from (e.g. main, feature/foo)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      has-diff: ${{ steps.diff.outputs.has-diff }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.target_branch || github.ref_name }}

      - name: Check for differences
        id: diff
        run: |
          # Compare against the most recent reachable v* tag on this branch.
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || true)
          if [ -n "$LAST_TAG" ]; then
            DIFF=$(git diff --quiet "$LAST_TAG" HEAD; echo $?)
          else
            DIFF=1
          fi

          if [ $DIFF -gt 0 ]; then
            echo "has-diff=true" >> $GITHUB_OUTPUT
            echo "Changes detected since last release"
          else
            echo "has-diff=false" >> $GITHUB_OUTPUT
            echo "No changes since last release"
          fi

  deploy-alpha:
    needs: check-diff
    if: needs.check-diff.outputs.has-diff == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.target_branch || github.ref_name }}

      - name: Get current version
        id: version
        run: |
          # Extract version from .toc file
          CURRENT_VERSION=$(grep "^## Version:" LariasWeeklyMidnightChecklist_Locales.toc | sed 's/## Version: //')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get branch name
          BRANCH_NAME="${{ inputs.target_branch || github.ref_name }}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: newversion
        env:
          CURRENT: ${{ steps.version.outputs.current }}
        run: |
          # Versioning rules for alpha:
          # - If CURRENT is already an alpha version, only bump the 4th component (build).
          # - If CURRENT is not alpha, bump PATCH once and start build at 1.
          # Examples:
          #   1.0.16          -> 1.0.17.1-alpha
          #   1.0.16-alpha    -> 1.0.16.1-alpha
          #   1.0.16.3-alpha  -> 1.0.16.4-alpha
          BASE_VERSION="${CURRENT%%-*}"
          IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$BASE_VERSION"

          IS_ALPHA=false
          case "$CURRENT" in
            *-alpha*) IS_ALPHA=true ;;
          esac

          if [ "$IS_ALPHA" = "true" ]; then
            if [ -z "${BUILD:-}" ]; then
              BUILD=0
            fi
            BUILD=$((BUILD + 1))
          else
            PATCH=$((PATCH + 1))
            BUILD=1
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH.$BUILD"
          ALPHA_VERSION="$NEW_VERSION-alpha"

          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "alpha=$ALPHA_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in .toc file
        env:
          ALPHA_VERSION: ${{ steps.newversion.outputs.alpha }}
        run: |
          sed -i "s/^## Version:.*/## Version: $ALPHA_VERSION/" LariasWeeklyMidnightChecklist_Locales.toc
          sed -i "s/^## Title:.*/## Title: Larias's Checklist: Localization (ALPHA)/" LariasWeeklyMidnightChecklist_Locales.toc

      - name: Commit and tag
        env:
          ALPHA_VERSION: ${{ steps.newversion.outputs.alpha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add LariasWeeklyMidnightChecklist_Locales.toc
          git commit -m "Alpha release (locales): $ALPHA_VERSION from ${{ steps.version.outputs.branch }}" || true
          git push origin "HEAD:${{ steps.version.outputs.branch }}" || true

          TAG="v$ALPHA_VERSION"
          git tag -a "$TAG" -m "Alpha Release $ALPHA_VERSION" 2>/dev/null || true
          git push origin "$TAG" 2>/dev/null || true

          echo "tag=$TAG" >> $GITHUB_ENV

      - name: Package + Upload (CurseForge & Wago)
        uses: BigWigsMods/packager@v2.4.3
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}

      - name: Notify Discord (alpha deployed)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          TAG: v${{ steps.newversion.outputs.alpha }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ steps.version.outputs.branch }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"

          CF_ID=$(sed -n 's/^curse-project-id:[[:space:]]*//p' .pkgmeta | head -n 1 | tr -d '[:space:]' || true)
          if [ -z "${CF_ID:-}" ]; then CF_ID=0; fi
          CURSE_LINE=""
          if [ "${CF_ID}" != "0" ]; then
            CURSE_URL=""
            if [ -n "${CF_API_KEY:-}" ]; then
              SLUG=$(curl -sS -H "x-api-key: ${CF_API_KEY}" "https://api.curseforge.com/v1/mods/${CF_ID}" \
                | python3 -c "import sys,json; data=json.load(sys.stdin).get('data') or {}; print(data.get('slug',''))" 2>/dev/null || true)
              if [ -n "${SLUG:-}" ]; then
                CURSE_URL="https://www.curseforge.com/wow/addons/${SLUG}"
              fi
            fi
            if [ -z "${CURSE_URL:-}" ]; then
              CURSE_URL="https://www.curseforge.com/wow/search?search=${CF_ID}"
            fi
            CURSE_LINE="\nðŸ”¥ CurseForge: ${CURSE_URL}"
          fi

          payload=$(cat <<EOF
          {
            "content": "ðŸ§ª **Larias's Checklist: Localization ${TAG}** (ALPHA from \`${BRANCH}\`) is ready!\n\nðŸ“¦ GitHub: ${RELEASE_URL}${CURSE_LINE}\nðŸ›  Workflow: ${RUN_URL}"
          }
          EOF
          )

          curl -sS -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL" || true

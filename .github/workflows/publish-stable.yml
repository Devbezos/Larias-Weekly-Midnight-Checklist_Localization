name: Publish Stable

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force a stable release even if no locales changes were detected"
        required: false
        type: boolean
        default: false
  schedule:
    # Check hourly for new commits and/or interface bumps.
    - cron: "0 * * * *"

concurrency:
  group: locales-publish-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  publish:
    # Avoid looping when this workflow pushes a version-bump commit.
    if: github.event_name != 'push' || github.actor != 'github-actions[bot]' || !contains(github.event.head_commit.message, 'Post-release:')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update .toc Interface versions (latest 3)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/update_toc_interface.py --toc LariasWeeklyChecklist_Localization.toc --count 3

      - name: Check for release-worthy changes
        id: check
        shell: bash
        env:
          FORCE_DEPLOY: ${{ github.event.inputs.force || 'false' }}
        run: |
          set -euo pipefail
          TOC="LariasWeeklyChecklist_Localization.toc"

          # Read the current version from the toc, stripping any pre-release suffix.
          RAW=$(grep "^## Version:" "$TOC" | sed 's/## Version:[[:space:]]*//')
          if [[ "$RAW" =~ ^([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "ERROR: could not parse version from toc: $RAW"; exit 1
          fi

          # Normalize toc: strip any alpha suffix, ensure stable title.
          sed -i "s/^## Version:.*/## Version: $VERSION/" "$TOC"
          sed -i "s/^## Title:.*/## Title: Larias's Weekly Checklist: Localization/" "$TOC"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # If this exact version tag is already on remote, there is nothing to do.
          # Avoids "tag already exists" failures when the push trigger races with a
          # completed scheduled run that already released this version.
          git fetch --tags --force
          if git ls-remote --tags origin "refs/tags/v$VERSION" | grep -q .; then
            echo "Tag v$VERSION already exists on remote; nothing to release."
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "should_commit=false"  >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the last stable release tag to compare locales against.
          LAST_TAG=$(git tag --list 'v*' --sort=-version:refname \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)
          echo "Last stable tag: ${LAST_TAG:-<none>}"

          LOCALES_CHANGED=false
          if [ -n "${LAST_TAG:-}" ]; then
            if ! git diff --quiet "${LAST_TAG}"..HEAD -- locales/; then
              LOCALES_CHANGED=true
            fi
          else
            LOCALES_CHANGED=true
          fi

          TOC_CHANGED=false
          if ! git diff --quiet -- "$TOC"; then TOC_CHANGED=true; fi

          echo "Locales changed since last stable tag: $LOCALES_CHANGED"
          echo "TOC changed: $TOC_CHANGED"

          SHOULD_RELEASE=false
          if [ "${FORCE_DEPLOY:-false}" = "true" ] || [ "$LOCALES_CHANGED" = "true" ]; then
            SHOULD_RELEASE=true
          fi

          # If only toc changed (interface bump) with no locales change, still commit but no release.
          SHOULD_COMMIT=false
          if [ "$TOC_CHANGED" = "true" ] || [ "$SHOULD_RELEASE" = "true" ]; then
            SHOULD_COMMIT=true
          fi

          echo "should_release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"
          echo "should_commit=$SHOULD_COMMIT"   >> "$GITHUB_OUTPUT"

      - name: Commit toc update (no release)
        if: steps.check.outputs.should_release == 'false' && steps.check.outputs.should_commit == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add LariasWeeklyChecklist_Localization.toc
          git diff --cached --quiet || { git commit -m "Auto-update toc (no release) [skip ci]"; git push; }

      - name: Tag at current version, then bump post-release
        if: steps.check.outputs.should_release == 'true'
        id: release
        shell: bash
        env:
          VERSION: ${{ steps.check.outputs.version }}
        run: |
          set -euo pipefail
          TOC="LariasWeeklyChecklist_Localization.toc"
          TAG="v$VERSION"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Generate CHANGELOG.md for this release so the packager uses curated
          # notes rather than the raw git log (which includes bot commits).
          PREV_STABLE=$(git tag --list 'v*' --sort=-version:refname \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)
          DATE=$(date -u +%Y-%m-%d)
          IFACE_LINE=$(sed -n 's/^## Interface:[[:space:]]*//p' "$TOC" | head -n 1 | tr -d '\n')
          CHANGED_LOCALES=""
          if [ -n "${PREV_STABLE:-}" ]; then
            CHANGED_LOCALES=$(git diff --name-only "${PREV_STABLE}"..HEAD -- locales/ \
              | sed -E 's|locales/||;s|_Data\.lua||;s|\.lua||' \
              | sort -u | tr '\n' ' ' | sed 's/ $//' || true)
          fi
          {
            echo "## [$VERSION] ($DATE)"
            # Human commits only â€” filter out all automated bot messages.
            if [ -n "${PREV_STABLE:-}" ]; then
              git log "${PREV_STABLE}..HEAD" --pretty=format:"- %s" --no-merges \
                | grep -v -iE "^- (post-release:|alpha release:|auto-update|release v)" \
                || true
            fi
            if [ -n "${CHANGED_LOCALES:-}" ]; then
              echo "- Updated locales: $CHANGED_LOCALES"
            fi
            echo "- Updated interface versions: $IFACE_LINE"
            echo ""
          } > .changelog_new
          [ -f CHANGELOG.md ] && cat CHANGELOG.md >> .changelog_new
          mv .changelog_new CHANGELOG.md

          # Commit toc + changelog at the stable version and tag it.
          git add "$TOC" CHANGELOG.md
          git diff --cached --quiet || git commit -m "Release $TAG [skip ci]"
          git tag -a "$TAG" -m "Release $TAG"
          git push
          git push origin "$TAG"

          # Post-release bump so the branch always starts at the next version.
          NEW_VERSION=$(python scripts/bump_toc_version.py --toc "$TOC")
          git add "$TOC"
          git commit -m "Post-release: bump version to $NEW_VERSION [skip ci]"
          git push

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Fetch tags and reset to release tag for packager
        if: steps.check.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          git reset --hard ${{ steps.release.outputs.tag }}

      - name: Package + Upload (CurseForge & Wago)
        if: steps.check.outputs.should_release == 'true'
        uses: BigWigsMods/packager@v2.4.3
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}

      - name: Notify Discord (release posted)
        if: steps.check.outputs.should_release == 'true' && success()
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TAG: ${{ steps.release.outputs.tag }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then exit 0; fi

          RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"
          MSG=" **Larias's Weekly Checklist: Localization ${TAG}** is live!\n\n GitHub: ${RELEASE_URL}\n Workflow: ${RUN_URL}"
          export MSG

          payload=$(python3 - <<'PY'
          import json, os
          print(json.dumps({"content": os.environ.get("MSG", "")}))
          PY
          )

          curl -sS -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL" || true

name: Deploy Stable (Locales)

on:
  workflow_dispatch:
  schedule:
    # Check hourly for new commits and/or interface bumps.
    - cron: "0 * * * *"

concurrency:
  group: locales-publish-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  publish:
    # Avoid looping when this workflow pushes a version-bump commit (push events).
    # Scheduled runs should still execute.
    if: github.event_name == 'schedule' || github.actor != 'github-actions[bot]'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update .toc Interface versions (latest 3)
        shell: bash
        run: |
          set -euo pipefail
          TOC="LariasWeeklyMidnightChecklist_Locales.toc"
          python scripts/update_toc_interface.py --toc "$TOC" --count 3

      - name: Commit + Tag + Push (only if repo changed since last release)
        id: commitstep
        shell: bash
        run: |
          set -euo pipefail

          TOC="LariasWeeklyMidnightChecklist_Locales.toc"

          # Ensure stable releases never keep an ALPHA display name.
          sed -i "s/^## Title:.*/## Title: Larias's Checklist: Localization/" "$TOC"

          # Detect whether we have any new commits since the last *stable* release tag.
          # Important: ignore alpha tags (vX.Y.Z.W-alpha), otherwise stable can get stuck
          # thinking nothing changed since the last alpha.
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || true)
          if [ -n "$LAST_TAG" ]; then
            COMMITS_SINCE_TAG=$(git rev-list --count "$LAST_TAG"..HEAD)
          else
            COMMITS_SINCE_TAG=999999
          fi

          echo "Last tag: ${LAST_TAG:-<none>}"
          echo "Commits since tag: ${COMMITS_SINCE_TAG}"

          TOC_CHANGED=false
          if ! git diff --quiet -- "$TOC"; then
            TOC_CHANGED=true
          fi

          echo "TOC changed (working tree): ${TOC_CHANGED}"
          echo "TOC Interface (after update): $(sed -n 's/^## Interface:[[:space:]]*//p' "$TOC" | head -n 1 | tr -d '[:space:]' || true)"

          # Nothing to publish.
          if [ "$COMMITS_SINCE_TAG" -eq 0 ] && [ "$TOC_CHANGED" = "false" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "released=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Always bump addon version for a publish.
          NEW_VERSION=$(python scripts/bump_toc_version.py --toc "$TOC")
          TAG="v$NEW_VERSION"

          git add "$TOC"
          git commit -m "Auto-release locales ($TAG) [skip ci]" || true
          git push

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "released=true" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Check packager config
        id: pkgmeta
        shell: bash
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
        run: |
          set -euo pipefail

          if [ ! -f .pkgmeta ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing .pkgmeta" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CF_ID=$(sed -n 's/^curse-project-id:[[:space:]]*//p' .pkgmeta | head -n 1 | tr -d '[:space:]' || true)
          WAGO_ID=$(sed -n 's/^wago-id:[[:space:]]*//p' .pkgmeta | head -n 1 | tr -d '"[:space:]' || true)

          if [ -z "$CF_ID" ]; then CF_ID=0; fi
          if [ "$CF_ID" = "0" ] && [ -z "$WAGO_ID" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "reason=project IDs not configured (.pkgmeta has curse-project-id: 0 and empty wago-id)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CF_ENABLED=false
          WAGO_ENABLED=false
          if [ "$CF_ID" != "0" ] && [ -n "${CF_API_KEY:-}" ]; then
            CF_ENABLED=true
          fi
          if [ -n "$WAGO_ID" ] && [ -n "${WAGO_API_TOKEN:-}" ]; then
            WAGO_ENABLED=true
          fi

          # Diagnostics (do not print secret values)
          echo "CurseForge project id: $CF_ID"
          echo "Wago id: ${WAGO_ID:-<empty>}"
          echo "CurseForge upload enabled: $CF_ENABLED"
          echo "Wago upload enabled: $WAGO_ENABLED"

          if [ "$CF_ENABLED" = "false" ] && [ "$WAGO_ENABLED" = "false" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing upload credentials (CF_API_KEY and/or WAGO_API_TOKEN secrets not set for configured project IDs)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "reason=ok" >> "$GITHUB_OUTPUT"
          echo "cf_enabled=$CF_ENABLED" >> "$GITHUB_OUTPUT"
          echo "wago_enabled=$WAGO_ENABLED" >> "$GITHUB_OUTPUT"

      - name: Package + Upload (CurseForge & Wago)
        if: steps.commitstep.outputs.released == 'true' && steps.pkgmeta.outputs.ready == 'true'
        uses: BigWigsMods/packager@v2.4.3
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}

      - name: Notify Discord (release posted)
        if: steps.commitstep.outputs.released == 'true' && success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          TAG: ${{ steps.commitstep.outputs.tag }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL not set; skipping Discord notification."
            exit 0
          fi

          RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"

          CF_ID=$(sed -n 's/^curse-project-id:[[:space:]]*//p' .pkgmeta | head -n 1 | tr -d '[:space:]' || true)
          if [ -z "${CF_ID:-}" ]; then CF_ID=0; fi
          CURSE_LINE=""
          if [ "${CF_ID}" != "0" ]; then
            CURSE_URL=""
            if [ -n "${CF_API_KEY:-}" ]; then
              SLUG=$(curl -sS -H "x-api-key: ${CF_API_KEY}" "https://api.curseforge.com/v1/mods/${CF_ID}" \
                | python3 -c "import sys,json; data=json.load(sys.stdin).get('data') or {}; print(data.get('slug',''))" 2>/dev/null || true)
              if [ -n "${SLUG:-}" ]; then
                CURSE_URL="https://www.curseforge.com/wow/addons/${SLUG}"
              fi
            fi
            if [ -z "${CURSE_URL:-}" ]; then
              CURSE_URL="https://www.curseforge.com/wow/search?search=${CF_ID}"
            fi
            CURSE_LINE="\nðŸ”¥ CurseForge: ${CURSE_URL}"
          fi

          payload=$(cat <<EOF
          {
            "content": "ðŸš€ **Larias's Checklist: Localization ${TAG}** is live!\n\nðŸ“¦ GitHub: ${RELEASE_URL}${CURSE_LINE}\nðŸ›  Workflow: ${RUN_URL}"
          }
          EOF
          )

          curl -sS -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL" || true

      - name: Note (upload skipped)
        if: steps.commitstep.outputs.released == 'true' && steps.pkgmeta.outputs.ready != 'true'
        shell: bash
        run: |
          echo "Release tag created: ${{ steps.commitstep.outputs.tag }}"
          echo "Upload skipped: ${{ steps.pkgmeta.outputs.reason }}"
